apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-kafka-consumer
spec:
  strategy:
    rollingUpdate:
      maxUnavailable: 0
  replicas: {{ .Values.replicaCount }}
  selector:
      matchLabels:
        app: {{ .Release.Name }}-kafka-consumer
  template:
    metadata:
      labels:
        app: {{ .Release.Name }}-kafka-consumer
      annotations:
        prometheus.io/path: {{ .Values.metrics.path }}
        prometheus.io/port: {{ .Values.port | quote }}
        prometheus.io/scrape: {{ .Values.metrics.enabled | quote }}        
    spec:
      serviceAccountName: {{ .Values.serviceAccountName }}
      containers:
        - name: kafka-consumer
          image: {{ .Values.image }}
          volumeMounts:
            - name: kafka-secrets-volume
              mountPath: /secrets-files
          ports:
            - containerPort: {{ .Values.port }}
          env:
            - name: KAFKA_BROKER
              value: {{ .Values.broker }}
            - name: GROUP_ID
              value: {{ .Values.groupId | default .Release.Name }}
            - name: TOPICS
              value: {{ .Values.topics }}                
            {{- if .Values.retry  }}
            - name: RETRY_TOPIC
              value: {{ .Values.retry.topic | default (printf "%s-retry" .Release.Name) }}
            {{- end }}
            {{- if .Values.deadLetter }}
            - name: DEAD_LETTER_TOPIC
              value: {{ .Values.deadLetter.topic | default (printf "%s-dead-letter" .Release.Name) }}
            {{- end }}
            - name: PROCESSING_DELAY
              value: {{ .Values.target.processingDelay | default "0" | squote}}
            - name: TARGET
              value: {{ .Values.target.baseUrl | default (printf "http://%s" .Release.Name) }}:{{ .Values.target.port }}{{ .Values.target.endpoint }}
            - name: TARGET_IS_ALIVE_ROUTE
              value: {{ .Values.target.baseUrl | default (printf "http://%s" .Release.Name) }}:{{ .Values.target.port }}{{ .Values.target.isAlive }}
            - name: USE_PROMETHEUS
              value: {{ .Values.usePrometheus | squote }}
            - name: MONITORING_SERVER_PORT
              value: {{ .Values.port | squote }}        
            - name: USE_SASL_AUTH
              value: 'true'
            - name: SASL_USERNAME
              value: {{ .Values.auth.saslUsername }}
            - name: SASL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: saslPassword
                  key: saslPassword
            - name: SASL_PASSWORD_FILE_PATH
              value: {{ .Values.auth.saslPasswordFilePath }}                  
            {{- if .Values.auth.trustsotre }}
            - name: TRUSTSTORE_FILE_PATH
              value: /secrets-files/truststore
            - name: TRUSTSTORE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: truststorePassword
                  key: truststorePassword            
            {{- end }}
          livenessProbe:
{{ toYaml .Values.livenessProbe | indent 12 }}
          readinessProbe:
{{ toYaml .Values.readinessProbe | indent 12 }}
          resources:
{{ toYaml .Values.resources | indent 12 }}
      volumes:
        - name: kafka-secrets-volume
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: {{ .Release.Name }}-kafka-consumer
